{% extends "base.html" %}

{% block title %}إدارة الموردين - نظام كاتيلو{% endblock %}

{% block page_header %}إدارة الموردين{% endblock %}

{% block content %}
<div x-data="suppliersApp">
    <!-- Header with actions -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">قائمة الموردين</h1>
        <button @click="openAddModal()" class="btn btn-primary flex items-center">
            <i class="fas fa-plus mr-2"></i> إضافة مورد جديد
        </button>
    </div>

    <!-- Search and filters -->
    <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
        <div class="flex flex-col md:flex-row gap-4">
            <div class="flex-1">
                <label for="search" class="block text-sm font-medium text-gray-700 mb-1">بحث</label>
                <div class="relative">
                    <input type="text" id="search" x-model="searchQuery" 
                           class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                           placeholder="ابحث باسم المورد...">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                </div>
            </div>
            <div class="w-full md:w-48">
                <label for="sort" class="block text-sm font-medium text-gray-700 mb-1">ترتيب حسب</label>
                <select id="sort" x-model="sortBy"
                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    <option value="supplier_name">الاسم</option>
                    <option value="rating">التقييم</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Suppliers list -->
    <div class="bg-white rounded-lg shadow-sm overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            اسم المورد
                        </th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            معلومات الاتصال
                        </th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            شروط الدفع
                        </th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            التقييم
                        </th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            الإجراءات
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-for="supplier in filteredSuppliers" :key="supplier.id">
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900" x-text="supplier.supplier_name"></div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-500" x-text="supplier.contact_info || 'غير متوفر'"></div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-500" x-text="supplier.payment_terms || 'غير متوفر'"></div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <template x-for="i in 5" :key="i">
                                        <i class="fas fa-star text-sm" :class="i <= supplier.rating ? 'text-yellow-400' : 'text-gray-300'"></i>
                                    </template>
                                    <span class="mr-2 text-sm text-gray-600" x-text="supplier.rating || 0"></span>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-left text-sm font-medium">
                                <div class="flex space-x-2 space-x-reverse">
                                    <button @click="viewSupplierItems(supplier)" class="text-blue-600 hover:text-blue-900">
                                        <i class="fas fa-boxes"></i>
                                    </button>
                                    <button @click="editSupplier(supplier)" class="text-indigo-600 hover:text-indigo-900">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button @click="confirmDelete(supplier)" class="text-red-600 hover:text-red-900">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </template>
                    <tr x-show="filteredSuppliers.length === 0">
                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                            لا توجد موردين متطابقة مع البحث
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add/Edit Supplier Modal -->
    <div x-show="showModal" class="fixed inset-0 overflow-y-auto z-50" x-cloak>
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">​</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-right overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:mt-0 sm:text-right sm:w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" x-text="isEditing ? 'تعديل المورد' : 'إضافة مورد جديد'"></h3>
                            <div class="mt-4 space-y-4">
                                <div>
                                    <label for="supplier_name" class="block text-sm font-medium text-gray-700">اسم المورد</label>
                                    <input type="text" id="supplier_name" x-model="currentSupplier.supplier_name"
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                </div>

                                <!-- New fields -->
                                <div>
                                    <label for="email" class="block text-sm font-medium text-gray-700">البريد الإلكتروني</label>
                                    <input type="email" id="email" x-model="currentSupplier.email"
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                </div>

                                <div>
                                    <label for="phone" class="block text-sm font-medium text-gray-700">رقم الهاتف</label>
                                    <input type="text" id="phone" x-model="currentSupplier.phone"
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                </div>

                                <div>
                                    <label for="contact_person" class="block text-sm font-medium text-gray-700">الشخص المسؤول</label>
                                    <input type="text" id="contact_person" x-model="currentSupplier.contact_person"
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                </div>

                                <div>
                                    <label for="address" class="block text-sm font-medium text-gray-700">العنوان</label>
                                    <textarea id="address" x-model="currentSupplier.address" rows="2"
                                          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></textarea>
                                </div>

                                <div>
                                    <label for="contact_info" class="block text-sm font-medium text-gray-700">معلومات الاتصال الإضافية</label>
                                    <textarea id="contact_info" x-model="currentSupplier.contact_info" rows="2"
                                          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></textarea>
                                </div>

                                <div>
                                    <label for="website" class="block text-sm font-medium text-gray-700">الموقع الإلكتروني</label>
                                    <input type="url" id="website" x-model="currentSupplier.website"
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                </div>

                                <div>
                                    <label for="tax_id" class="block text-sm font-medium text-gray-700">الرقم الضريبي</label>
                                    <input type="text" id="tax_id" x-model="currentSupplier.tax_id"
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                </div>

                                <div>
                                    <label for="payment_terms" class="block text-sm font-medium text-gray-700">شروط الدفع</label>
                                    <input type="text" id="payment_terms" x-model="currentSupplier.payment_terms"
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                </div>

                                <div>
                                    <label for="rating" class="block text-sm font-medium text-gray-700">التقييم (1-5)</label>
                                    <input type="number" id="rating" x-model="currentSupplier.rating" min="0" max="5" step="0.1"
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button @click="saveSupplier()" type="button"
                            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                        حفظ
                    </button>
                    <button @click="closeModal()" type="button"
                            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        إلغاء
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div x-show="showDeleteModal" class="fixed inset-0 overflow-y-auto z-50" x-cloak>
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">​</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-right overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                            <i class="fas fa-exclamation-triangle text-red-600"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:mr-4 sm:text-right">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">حذف المورد</h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500">
                                    هل أنت متأكد من رغبتك في حذف هذا المورد؟ لا يمكن التراجع عن هذا الإجراء.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button @click="deleteSupplier()" type="button" 
                            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
                        حذف
                    </button>
                    <button @click="showDeleteModal = false" type="button" 
                            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        إلغاء
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('suppliersApp', () => ({
            suppliers: [],
            searchQuery: '',
            sortBy: 'supplier_name',
            showModal: false,
            showDeleteModal: false,
            isEditing: false,
            currentSupplier: {
                id: null,
                supplier_name: '',
                contact_info: '',
                payment_terms: '',
                rating: 0,
                email: '',
                phone: '',
                address: '',
                tax_id: '',
                website: '',
                contact_person: ''
            },
            
            init() {
                this.fetchSuppliers();
            },
            
            get filteredSuppliers() {
                let filtered = [...this.suppliers];
                
                // Apply search filter
                if (this.searchQuery) {
                    const query = this.searchQuery.toLowerCase();
                    filtered = filtered.filter(supplier => 
                        supplier.supplier_name.toLowerCase().includes(query) ||
                        (supplier.contact_info && supplier.contact_info.toLowerCase().includes(query))
                    );
                }
                
                // Apply sorting
                filtered.sort((a, b) => {
                    if (this.sortBy === 'rating') {
                        return (b.rating || 0) - (a.rating || 0);
                    } else {
                        return a.supplier_name.localeCompare(b.supplier_name);
                    }
                });
                
                return filtered;
            },
            
            async fetchSuppliers() {
                try {
                    const response = await fetch('/api/suppliers');
                    if (!response.ok) throw new Error('فشل في جلب بيانات الموردين');
                    this.suppliers = await response.json();
                } catch (error) {
                    console.error('Error fetching suppliers:', error);
                    showNotification(error.message, 'error');
                }
            },
            
            openAddModal() {
                this.isEditing = false;
                this.currentSupplier = {
                    id: null,
                    supplier_name: '',
                    contact_info: '',
                    payment_terms: '',
                    rating: 0,
                    email: '',
                    phone: '',
                    address: '',
                    tax_id: '',
                    website: '',
                    contact_person: ''
                };
                this.showModal = true;
            },
            
            editSupplier(supplier) {
                this.isEditing = true;
                this.currentSupplier = { ...supplier };
                this.showModal = true;
            },
            
            closeModal() {
                this.showModal = false;
            },
            
            async saveSupplier() {
                try {
                    // Validate required fields
                    if (!this.currentSupplier.supplier_name) {
                        showNotification('اسم المورد مطلوب', 'error');
                        return;
                    }
                    
                    let response;
                    if (this.isEditing) {
                        // Update existing supplier
                        response = await fetch(`/api/suppliers/${this.currentSupplier.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(this.currentSupplier)
                        });
                    } else {
                        // Create new supplier
                        response = await fetch('/api/suppliers', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(this.currentSupplier)
                        });
                    }
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.message || 'فشل في حفظ بيانات المورد');
                    }
                    
                    // Refresh suppliers list
                    await this.fetchSuppliers();
                    this.closeModal();
                    showNotification(this.isEditing ? 'تم تحديث المورد بنجاح' : 'تم إضافة المورد بنجاح', 'success');
                } catch (error) {
                    console.error('Error saving supplier:', error);
                    showNotification(error.message, 'error');
                }
            },
            
            confirmDelete(supplier) {
                this.currentSupplier = supplier;
                this.showDeleteModal = true;
            },
            
            async deleteSupplier() {
                try {
                    const response = await fetch(`/api/suppliers/${this.currentSupplier.id}`, {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.message || 'فشل في حذف المورد');
                    }
                    
                    // Refresh suppliers list
                    await this.fetchSuppliers();
                    this.showDeleteModal = false;
                    showNotification('تم حذف المورد بنجاح', 'success');
                } catch (error) {
                    console.error('Error deleting supplier:', error);
                    showNotification(error.message, 'error');
                }
            },
            
            viewSupplierItems(supplier) {
                window.location.href = `/supplier-items-management?supplier_id=${supplier.id}`;
            }
        }));
    });
</script>
{% endblock %}

