{% extends 'base.html' %}

{% block title %}تتبع دفعات الإنتاج - نظام كاتيلو{% endblock %}

{% block page_header %}تتبع دفعات الإنتاج{% endblock %}

{% block content %}
<div x-data="batchTracking()">
    <div class="mb-6 flex justify-between items-center">
        <div class="flex items-center space-x-4 space-x-reverse">
            <h2 class="text-xl font-bold text-gray-800">تتبع دفعات الإنتاج</h2>
            <div class="relative">
                <input 
                    type="text" 
                    x-model="searchQuery" 
                    @input="filterBatches()"
                    placeholder="بحث..." 
                    class="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
            </div>
        </div>
        <button 
            @click="openCreateModal()"
            class="btn btn-primary flex items-center">
            <i class="fas fa-plus ml-2"></i>
            دفعة جديدة
        </button>
    </div>

    <div class="card">
        <!-- Filter Controls -->
        <div class="p-4 border-b border-gray-200 bg-gray-50 flex flex-wrap gap-4 items-center">
            <div class="flex-grow">
                <label class="block text-sm font-medium text-gray-700 mb-1">تصفية حسب المنتج</label>
                <select 
                    x-model="filters.itemId" 
                    @change="filterBatches()"
                    class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    <option value="">جميع المنتجات</option>
                    <template x-for="product in products" :key="product.id">
                        <option :value="product.id" x-text="product.name"></option>
                    </template>
                </select>
            </div>
            <div class="flex-grow">
                <label class="block text-sm font-medium text-gray-700 mb-1">تصفية حسب تاريخ الإنتاج</label>
                <div class="flex space-x-2 space-x-reverse">
                    <div class="flex-grow">
                        <input 
                            type="date" 
                            x-model="filters.startDate" 
                            @change="filterBatches()"
                            class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div class="flex-grow">
                        <input 
                            type="date" 
                            x-model="filters.endDate" 
                            @change="filterBatches()"
                            class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">عرض</label>
                <select 
                    x-model="filters.status" 
                    @change="filterBatches()"
                    class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    <option value="">الكل</option>
                    <option value="active">الدفعات النشطة</option>
                    <option value="expired">الدفعات المنتهية</option>
                </select>
            </div>
            <div class="flex items-end">
                <button 
                    @click="resetFilters()"
                    class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <i class="fas fa-redo ml-2"></i>
                    إعادة ضبط
                </button>
            </div>
        </div>

        <!-- Batches Table -->
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            #
                        </th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            المنتج
                        </th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            رقم الدفعة
                        </th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            تاريخ الإنتاج
                        </th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            تاريخ الانتهاء
                        </th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            الكمية
                        </th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            الإجراءات
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-if="loading">
                        <tr>
                            <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                                <i class="fas fa-spinner fa-spin ml-2"></i>
                                جاري التحميل...
                            </td>
                        </tr>
                    </template>
                    <template x-if="!loading && filteredBatches.length === 0">
                        <tr>
                            <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                                لا توجد دفعات إنتاج
                            </td>
                        </tr>
                    </template>
                    <template x-for="batch in filteredBatches" :key="batch.id">
                        <tr :class="{'bg-red-50': isExpired(batch)}">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="batch.id"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="batch.item_name"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="batch.lot_number"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="formatDate(batch.production_date)"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                <span :class="{'text-red-600': isExpired(batch)}" x-text="formatDate(batch.expiry_date)"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="batch.quantity"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <div class="flex space-x-2 space-x-reverse">
                                    <button @click="viewBatchDetails(batch)" class="text-blue-600 hover:text-blue-900 tooltip" data-tooltip="عرض التفاصيل">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button @click="editBatch(batch)" class="text-indigo-600 hover:text-indigo-900 tooltip" data-tooltip="تعديل">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button @click="printBatchLabel(batch)" class="text-green-600 hover:text-green-900 tooltip" data-tooltip="طباعة الملصق">
                                        <i class="fas fa-print"></i>
                                    </button>
                                    <button @click="quickAddToSlot(batch)" class="text-purple-600 hover:text-purple-900 tooltip" data-tooltip="إضافة سريعة للموقع">
                                        <i class="fas fa-box-open"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- Create/Edit Batch Modal -->
        <div x-show="showModal" class="fixed inset-0 z-50 overflow-y-auto" x-cloak>
            <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                <div 
                    x-show="showModal" 
                    x-transition:enter="ease-out duration-300" 
                    x-transition:enter-start="opacity-0" 
                    x-transition:enter-end="opacity-100" 
                    x-transition:leave="ease-in duration-200" 
                    x-transition:leave-start="opacity-100" 
                    x-transition:leave-end="opacity-0"
                    class="fixed inset-0 transition-opacity" 
                    @click="showModal = false">
                    <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
                </div>

                <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>

                <div 
                    x-show="showModal" 
                    x-transition:enter="ease-out duration-300" 
                    x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" 
                    x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" 
                    x-transition:leave="ease-in duration-200" 
                    x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" 
                    x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                    class="inline-block align-bottom bg-white rounded-lg text-right overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                    
                    <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
                            <span x-text="editMode ? 'تعديل دفعة الإنتاج' : 'إضافة دفعة إنتاج جديدة'"></span>
                        </h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">المنتج</label>
                                <select 
                                    x-model="formData.item_id"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    <option value="">اختر المنتج</option>
                                    <template x-for="product in products" :key="product.id">
                                        <option :value="product.id" x-text="product.name"></option>
                                    </template>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">رقم الدفعة</label>
                                <input 
                                    type="text" 
                                    x-model="formData.lot_number"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">تاريخ الإنتاج</label>
                                    <input 
                                        type="date" 
                                        x-model="formData.production_date"
                                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">تاريخ الانتهاء</label>
                                    <input 
                                        type="date" 
                                        x-model="formData.expiry_date"
                                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">الكمية</label>
                                    <input 
                                        type="number" 
                                        x-model="formData.quantity"
                                        min="0"
                                        step="0.01"
                                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">المستودع</label>
                                    <select 
                                        x-model="formData.warehouse_id"
                                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        <option value="">اختر المستودع</option>
                                        <template x-for="warehouse in warehouses" :key="warehouse.id">
                                            <option :value="warehouse.id" x-text="warehouse.name"></option>
                                        </template>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Auto-calculate expiry date based on product shelf life -->
                            <div class="flex items-center">
                                <input 
                                    type="checkbox" 
                                    id="auto_expiry" 
                                    x-model="autoCalculateExpiry"
                                    class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded ml-2">
                                <label for="auto_expiry" class="text-sm text-gray-700">
                                    حساب تاريخ الانتهاء تلقائيًا (حسب مدة صلاحية المنتج)
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                        <button 
                            type="button"
                            @click="saveBatch()"
                            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                            <span x-text="editMode ? 'تحديث' : 'إضافة'"></span>
                        </button>
                        <button 
                            type="button"
                            @click="showModal = false"
                            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                            إلغاء
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- View Batch Details Modal -->
        <div x-show="showDetailsModal" class="fixed inset-0 z-50 overflow-y-auto" x-cloak>
            <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                <div 
                    x-show="showDetailsModal" 
                    x-transition:enter="ease-out duration-300" 
                    x-transition:enter-start="opacity-0" 
                    x-transition:enter-end="opacity-100" 
                    x-transition:leave="ease-in duration-200" 
                    x-transition:leave-start="opacity-100" 
                    x-transition:leave-end="opacity-0"
                    class="fixed inset-0 transition-opacity" 
                    @click="showDetailsModal = false">
                    <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
                </div>

                <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>

                <div 
                    x-show="showDetailsModal" 
                    x-transition:enter="ease-out duration-300" 
                    x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" 
                    x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" 
                    x-transition:leave="ease-in duration-200" 
                    x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" 
                    x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                    class="inline-block align-bottom bg-white rounded-lg text-right overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
                    
                    <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">
                                تفاصيل دفعة الإنتاج
                            </h3>
                            <div class="flex space-x-2 space-x-reverse">
                                <button 
                                    @click="printBatchLabel(selectedBatch)" 
                                    class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                    <i class="fas fa-print ml-1"></i>
                                    طباعة
                                </button>
                                <button 
                                    @click="openAddToSlotModal()" 
                                    class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                    <i class="fas fa-plus ml-1"></i>
                                    إضافة للموقع
                                </button>
                            </div>
                        </div>
                        
                        <div class="space-y-6">
                            <!-- Batch Info Card -->
                            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-500">المنتج</p>
                                        <p class="font-medium" x-text="selectedBatch.item_name"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">رقم الدفعة</p>
                                        <p class="font-medium" x-text="selectedBatch.lot_number"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">الكمية</p>
                                        <p class="font-medium" x-text="selectedBatch.quantity"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">تاريخ الإنتاج</p>
                                        <p class="font-medium" x-text="formatDate(selectedBatch.production_date)"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">تاريخ الانتهاء</p>
                                        <p class="font-medium" :class="{'text-red-600': isExpired(selectedBatch)}" x-text="formatDate(selectedBatch.expiry_date)"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">الحالة</p>
                                        <p class="font-medium">
                                            <span 
                                                :class="isExpired(selectedBatch) ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'" 
                                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                                x-text="isExpired(selectedBatch) ? 'منتهية الصلاحية' : 'سارية'">
                                            </span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Storage Locations -->
                            <div>
                                <h4 class="text-md font-medium text-gray-900 mb-2">مواقع التخزين</h4>
                                <div class="border rounded-md overflow-hidden">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المستودع</th>
                                                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">القسم</th>
                                                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الموقع</th>
                                                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الكمية</th>
                                                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الإجراءات</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            <template x-if="slotsLoading">
                                                <tr>
                                                    <td colspan="5" class="px-4 py-2 text-center text-gray-500">
                                                        <i class="fas fa-spinner fa-spin ml-2"></i>
                                                        جاري التحميل...
                                                    </td>
                                                </tr>
                                            </template>
                                            <template x-if="!slotsLoading && batchSlots.length === 0">
                                                <tr>
                                                    <td colspan="5" class="px-4 py-2 text-center text-gray-500">
                                                        لا توجد مواقع تخزين لهذه الدفعة
                                                    </td>
                                                </tr>
                                            </template>
                                            <template x-for="slot in batchSlots" :key="slot.id">
                                                <tr>
                                                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900" x-text="slot.warehouse_name"></td>
                                                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900" x-text="slot.section_name"></td>
                                                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900" x-text="slot.position"></td>
                                                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900" x-text="slot.quantity_in_slot"></td>
                                                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium">
                                                        <button @click="removeBatchFromSlot(slot)" class="text-red-600 hover:text-red-900">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Production Processes -->
                            <div x-show="batchProcesses.length > 0">
                                <h4 class="text-md font-medium text-gray-900 mb-2">مراحل الإنتاج</h4>
                                <div class="border rounded-md overflow-hidden">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المرحلة</th>
                                                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">وقت البدء</th>
                                                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">وقت الانتهاء</th>
                                                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المشغل</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            <template x-for="process in batchProcesses" :key="process.id">
                                                <tr>
                                                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900" x-text="process.process_type"></td>
                                                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900" x-text="formatDateTime(process.start_time)"></td>
                                                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900" x-text="formatDateTime(process.end_time)"></td>
                                                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900" x-text="process.operator_name"></td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                        <button 
                            type="button"
                            @click="showDetailsModal = false"
                            class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                            إغلاق
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add to Slot Modal -->
        <div x-show="showAddToSlotModal" class="fixed inset-0 z-50 overflow-y-auto" x-cloak>
            <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                <div 
                    x-show="showAddToSlotModal" 
                    x-transition:enter="ease-out duration-300" 
                    x-transition:enter-start="opacity-0" 
                    x-transition:enter-end="opacity-100" 
                    x-transition:leave="ease-in duration-200" 
                    x-transition:leave-start="opacity-100" 
                    x-transition:leave-end="opacity-0"
                    class="fixed inset-0 transition-opacity" 
                    @click="showAddToSlotModal = false">
                    <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
                </div>

                <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>

                <div 
                    x-show="showAddToSlotModal" 
                    x-transition:enter="ease-out duration-300" 
                    x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" 
                    x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" 
                    x-transition:leave="ease-in duration-200" 
                    x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" 
                    x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                    class="inline-block align-bottom bg-white rounded-lg text-right overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                    
                    <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
                            إضافة الدفعة إلى موقع تخزين
                        </h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">المستودع</label>
                                <select 
                                    x-model="slotData.warehouse_id"
                                    @change="loadWarehouseSections()"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    <option value="">اختر المستودع</option>
                                    <template x-for="warehouse in warehouses" :key="warehouse.id">
                                        <option :value="warehouse.id" x-text="warehouse.name"></option>
                                    </template>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">القسم</label>
                                <select 
                                    x-model="slotData.section_id"
                                    @change="loadSectionSlots()"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    <option value="">اختر القسم</option>
                                    <template x-for="section in warehouseSections" :key="section.id">
                                        <option :value="section.id" x-text="section.section_name"></option>
                                    </template>
                                </select>
                            </div>
                            
                            <div x-show="slotData.section_id">
                                <div class="flex justify-between items-center mb-2">
                                    <label class="block text-sm font-medium text-gray-700">الموقع</label>
                                    <div class="flex items-center">
                                        <input 
                                            type="checkbox" 
                                            id="create_new_slot" 
                                            x-model="createNewSlot"
                                            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded ml-2">
                                        <label for="create_new_slot" class="text-sm text-gray-700">
                                            إنشاء موقع جديد
                                        </label>
                                    </div>
                                </div>
                                
                                <div x-show="!createNewSlot">
                                    <select 
                                        x-model="slotData.slot_id"
                                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        <option value="">اختر الموقع</option>
                                        <template x-for="slot in sectionSlots" :key="slot.id">
                                            <option :value="slot.id" x-text="`صف ${slot.row_number} - عمود ${slot.column_number}`"></option>
                                        </template>
                                    </select>
                                </div>
                                
                                <div x-show="createNewSlot" class="mt-2">
                                    <p class="text-sm text-gray-500 mb-2">سيتم إنشاء موقع جديد في القسم المحدد</p>
                                    <input type="hidden" x-model="slotData.create_new_slot" :value="createNewSlot">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">الكمية</label>
                                <input 
                                    type="number" 
                                    x-model="slotData.quantity_in_slot"
                                    min="0.01"
                                    step="0.01"
                                    :max="selectedBatch.quantity"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <p class="mt-1 text-sm text-gray-500">
                                    الكمية المتاحة: <span x-text="selectedBatch.quantity"></span>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                        <button 
                            type="button"
                            @click="saveBatchToSlot()"
                            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                            حفظ
                        </button>
                        <button 
                            type="button"
                            @click="showAddToSlotModal = false"
                            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                            إلغاء
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Add to Slot Modal -->
        <div x-show="showQuickAddModal" class="fixed inset-0 z-50 overflow-y-auto" x-cloak>
            <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                <div 
                    x-show="showQuickAddModal" 
                    x-transition:enter="ease-out duration-300" 
                    x-transition:enter-start="opacity-0" 
                    x-transition:enter-end="opacity-100" 
                    x-transition:leave="ease-in duration-200" 
                    x-transition:leave-start="opacity-100" 
                    x-transition:leave-end="opacity-0"
                    class="fixed inset-0 transition-opacity" 
                    @click="showQuickAddModal = false">
                    <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
                </div>

                <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>

                <div 
                    x-show="showQuickAddModal" 
                    x-transition:enter="ease-out duration-300" 
                    x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                    x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" 
                    x-transition:leave="ease-in duration-200" 
                    x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" 
                    x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                    class="inline-block align-bottom bg-white rounded-lg text-right overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                    
                    <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
                            إضافة سريعة للموقع
                        </h3>
                        
                        <div class="space-y-4">
                            <div class="bg-blue-50 border border-blue-200 rounded-md p-3 mb-4">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-info-circle text-blue-400"></i>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm text-blue-700">
                                            يمكنك إضافة الدفعة إلى موقع تخزين جديد بسرعة. سيتم إنشاء موقع جديد في القسم المحدد تلقائيًا.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">المستودع</label>
                                <select 
                                    x-model="quickAddData.warehouse_id"
                                    @change="loadWarehouseSections(true)"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    <option value="">اختر المستودع</option>
                                    <template x-for="warehouse in warehouses" :key="warehouse.id">
                                        <option :value="warehouse.id" x-text="warehouse.name"></option>
                                    </template>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">القسم</label>
                                <select 
                                    x-model="quickAddData.section_id"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    <option value="">اختر القسم</option>
                                    <template x-for="section in quickAddSections" :key="section.id">
                                        <option :value="section.id" x-text="section.section_name"></option>
                                    </template>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">الكمية</label>
                                <input 
                                    type="number" 
                                    x-model="quickAddData.quantity_in_slot"
                                    min="0.01"
                                    step="0.01"
                                    :max="selectedBatch.quantity"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <p class="mt-1 text-sm text-gray-500">
                                    الكمية المتاحة: <span x-text="selectedBatch.quantity"></span>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                        <button 
                            type="button"
                            @click="saveQuickAddToSlot()"
                            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                            حفظ
                        </button>
                        <button 
                            type="button"
                            @click="showQuickAddModal = false"
                            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                            إلغاء
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Batch Label Print Modal -->
        <div x-show="showPrintModal" class="fixed inset-0 z-50 overflow-y-auto" x-cloak>
            <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                <div 
                    x-show="showPrintModal" 
                    x-transition:enter="ease-out duration-300" 
                    x-transition:enter-start="opacity-0" 
                    x-transition:enter-end="opacity-100" 
                    x-transition:leave="ease-in duration-200" 
                    x-transition:leave-start="opacity-100" 
                    x-transition:leave-end="opacity-0"
                    class="fixed inset-0 transition-opacity" 
                    @click="showPrintModal = false">
                    <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
                </div>

                <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>

                <div 
                    x-show="showPrintModal" 
                    x-transition:enter="ease-out duration-300" 
                    x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" 
                    x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" 
                    x-transition:leave="ease-in duration-200" 
                    x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" 
                    x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                    class="inline-block align-bottom bg-white rounded-lg text-right overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                    
                    <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
                            طباعة ملصق الدفعة
                        </h3>
                        
                        <div id="batch-label" class="border border-gray-300 p-4 rounded-md mb-4">
                            <div class="text-center mb-4">
                                <h2 class="text-xl font-bold">شركة كاتيلو للأجبان</h2>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2 mb-4">
                                <div>
                                    <p class="text-sm text-gray-500">المنتج</p>
                                    <p class="font-medium" x-text="selectedBatch.item_name"></p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">رقم الدفعة</p>
                                    <p class="font-medium" x-text="selectedBatch.lot_number"></p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">تاريخ الإنتاج</p>
                                    <p class="font-medium" x-text="formatDate(selectedBatch.production_date)"></p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">تاريخ الانتهاء</p>
                                    <p class="font-medium" x-text="formatDate(selectedBatch.expiry_date)"></p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">الكمية</p>
                                    <p class="font-medium" x-text="selectedBatch.quantity"></p>
                                </div>
                            </div>
                            
                            <div class="text-center">
                                <div class="inline-block p-2 border border-gray-300 rounded">
                                    <!-- Placeholder for barcode -->
                                    <p class="text-xs text-gray-500">رمز الدفعة</p>
                                    <p class="font-mono text-sm" x-text="selectedBatch.lot_number"></p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-center">
                            <button 
                                @click="printLabel()"
                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                <i class="fas fa-print ml-2"></i>
                                طباعة الملصق
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                        <button 
                            type="button"
                            @click="showPrintModal = false"
                            class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                            إغلاق
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function batchTracking() {
        return {
            loading: true,
            slotsLoading: false,
            batches: [],
            filteredBatches: [],
            products: [],
            warehouses: [],
            warehouseSections: [],
            quickAddSections: [],
            sectionSlots: [],
            batchSlots: [],
            batchProcesses: [],
            showModal: false,
            showDetailsModal: false,
            showAddToSlotModal: false,
            showQuickAddModal: false,
            showPrintModal: false,
            editMode: false,
            createNewSlot: false,
            autoCalculateExpiry: true,
            selectedBatch: {},
            searchQuery: '',
            filters: {
                itemId: '',
                startDate: '',
                endDate: '',
                status: ''
            },
            formData: {
                item_id: '',
                lot_number: '',
                production_date: new Date().toISOString().split('T')[0],
                expiry_date: '',
                quantity: 0,
                warehouse_id: ''
            },
            slotData: {
                batch_id: '',
                slot_id: '',
                section_id: '',
                warehouse_id: '',
                quantity_in_slot: 0,
                create_new_slot: false
            },
            quickAddData: {
                batch_id: '',
                section_id: '',
                warehouse_id: '',
                quantity_in_slot: 0
            },
            
            init() {
                this.loadBatches();
                this.loadProducts();
                this.loadWarehouses();
                
                // Watch for product selection to auto-calculate expiry date
                this.$watch('formData.item_id', (value) => {
                    if (this.autoCalculateExpiry && value) {
                        const product = this.products.find(p => p.id == value);
                        if (product && product.shelf_life_days) {
                            const productionDate = new Date(this.formData.production_date);
                            if (productionDate) {
                                const expiryDate = new Date(productionDate);
                                expiryDate.setDate(expiryDate.getDate() + product.shelf_life_days);
                                this.formData.expiry_date = expiryDate.toISOString().split('T')[0];
                            }
                        }
                    }
                });
                
                // Watch for production date changes to update expiry date
                this.$watch('formData.production_date', (value) => {
                    if (this.autoCalculateExpiry && this.formData.item_id) {
                        const product = this.products.find(p => p.id == this.formData.item_id);
                        if (product && product.shelf_life_days && value) {
                            const productionDate = new Date(value);
                            const expiryDate = new Date(productionDate);
                            expiryDate.setDate(expiryDate.getDate() + product.shelf_life_days);
                            this.formData.expiry_date = expiryDate.toISOString().split('T')[0];
                        }
                    }
                });
            },
            
            loadBatches() {
                this.loading = true;
                fetchAPI('/api/batches')
                    .then(data => {
                        this.batches = data;
                        this.filteredBatches = data;
                        this.loading = false;
                    })
                    .catch(error => {
                        console.error('Error loading batches:', error);
                        this.loading = false;
                    });
            },
            
            loadProducts() {
                fetchAPI('/api/items')
                    .then(data => {
                        this.products = data;
                    })
                    .catch(error => {
                        console.error('Error loading products:', error);
                    });
            },
            
            loadWarehouses() {
                fetchAPI('/api/warehouses')
                    .then(data => {
                        this.warehouses = data;
                    })
                    .catch(error => {
                        console.error('Error loading warehouses:', error);
                    });
            },
            
            loadWarehouseSections(isQuickAdd = false) {
                const warehouseId = isQuickAdd ? this.quickAddData.warehouse_id : this.slotData.warehouse_id;
                if (!warehouseId) return;
                
                fetchAPI(`/api/warehouses/${warehouseId}/sections`)
                    .then(data => {
                        if (isQuickAdd) {
                            this.quickAddSections = data;
                            this.quickAddData.section_id = '';
                        } else {
                            this.warehouseSections = data;
                            this.slotData.section_id = '';
                            this.slotData.slot_id = '';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading warehouse sections:', error);
                    });
            },
            
            loadSectionSlots() {
                if (!this.slotData.section_id) return;
                
                fetchAPI(`/api/warehouse-sections/${this.slotData.section_id}/slots`)
                    .then(data => {
                        // Filter slots that are empty or contain the same item
                        this.sectionSlots = data.filter(slot => 
                            !slot.item_id || slot.item_id == this.selectedBatch.item_id
                        );
                        this.slotData.slot_id = '';
                    })
                    .catch(error => {
                        console.error('Error loading section slots:', error);
                    });
            },
            
            loadBatchSlots(batchId) {
                this.slotsLoading = true;
                fetchAPI(`/api/batches/${batchId}/slots`)
                    .then(data => {
                        this.batchSlots = data;
                        this.slotsLoading = false;
                    })
                    .catch(error => {
                        console.error('Error loading batch slots:', error);
                        this.slotsLoading = false;
                    });
            },
            
            loadBatchProcesses(batchId) {
                fetchAPI(`/api/production-processes?batch_id=${batchId}`)
                    .then(data => {
                        this.batchProcesses = data.filter(process => process.batch_id == batchId);
                    })
                    .catch(error => {
                        console.error('Error loading batch processes:', error);
                    });
            },
            
            openCreateModal() {
                this.editMode = false;
                this.formData = {
                    item_id: '',
                    lot_number: '',
                    production_date: new Date().toISOString().split('T')[0],
                    expiry_date: '',
                    quantity: 0,
                    warehouse_id: ''
                };
                this.showModal = true;
            },
            
            editBatch(batch) {
                this.editMode = true;
                this.formData = {
                    id: batch.id,
                    item_id: batch.item_id,
                    lot_number: batch.lot_number,
                    production_date: batch.production_date ? batch.production_date.split('T')[0] : '',
                    expiry_date: batch.expiry_date ? batch.expiry_date.split('T')[0] : '',
                    quantity: batch.quantity,
                    warehouse_id: ''  // We don't have this info in the batch data
                };
                this.showModal = true;
            },
            
            saveBatch() {
                // Validate form
                if (!this.formData.item_id || !this.formData.lot_number) {
                    showNotification('يرجى ملء جميع الحقول المطلوبة', 'error');
                    return;
                }
                
                const url = this.editMode ? `/api/batches/${this.formData.id}` : '/api/batches';
                const method = this.editMode ? 'PUT' : 'POST';
                
                fetchAPI(url, method, this.formData)
                    .then(data => {
                        showNotification(data.message, 'success');
                        this.showModal = false;
                        this.loadBatches();
                    })
                    .catch(error => {
                        console.error('Error saving batch:', error);
                        showNotification('حدث خطأ أثناء حفظ الدفعة', 'error');
                    });
            },
            
            viewBatchDetails(batch) {
                this.selectedBatch = batch;
                this.loadBatchSlots(batch.id);
                this.loadBatchProcesses(batch.id);
                this.showDetailsModal = true;
            },
            
            openAddToSlotModal() {
                this.slotData = {
                    batch_id: this.selectedBatch.id,
                    slot_id: '',
                    section_id: '',
                    warehouse_id: '',
                    quantity_in_slot: this.selectedBatch.quantity > 0 ? this.selectedBatch.quantity : 0,
                    create_new_slot: false
                };
                this.createNewSlot = false;
                this.showAddToSlotModal = true;
            },
            
            quickAddToSlot(batch) {
                this.selectedBatch = batch;
                this.quickAddData = {
                    batch_id: batch.id,
                    section_id: '',
                    warehouse_id: '',
                    quantity_in_slot: batch.quantity > 0 ? batch.quantity : 0
                };
                this.showQuickAddModal = true;
            },
            
            saveBatchToSlot() {
                // Validate form
                if ((!this.slotData.slot_id && !this.createNewSlot) || 
                    !this.slotData.quantity_in_slot || 
                    !this.slotData.section_id) {
                    showNotification('يرجى ملء جميع الحقول المطلوبة', 'error');
                    return;
                }
                
                // Prepare data
                const data = {
                    batch_id: this.slotData.batch_id,
                    quantity_in_slot: parseFloat(this.slotData.quantity_in_slot)
                };
                
                if (this.createNewSlot) {
                    data.create_new_slot = true;
                    data.section_id = this.slotData.section_id;
                } else {
                    data.slot_id = this.slotData.slot_id;
                }
                
                // Save to API
                fetchAPI('/api/batch-slots', 'POST', data)
                    .then(response => {
                        showNotification(response.message, 'success');
                        this.showAddToSlotModal = false;
                        this.loadBatchSlots(this.selectedBatch.id);
                        this.loadBatches();  // Refresh batches to update quantities
                    })
                    .catch(error => {
                        console.error('Error saving batch to slot:', error);
                        showNotification('حدث خطأ أثناء حفظ الدفعة في الموقع', 'error');
                    });
            },
            
            saveQuickAddToSlot() {
                // Validate form
                if (!this.quickAddData.section_id || !this.quickAddData.quantity_in_slot) {
                    showNotification('يرجى ملء جميع الحقول المطلوبة', 'error');
                    return;
                }
                
                // Prepare data
                const data = {
                    batch_id: this.quickAddData.batch_id,
                    quantity_in_slot: parseFloat(this.quickAddData.quantity_in_slot),
                    create_new_slot: true,
                    section_id: this.quickAddData.section_id
                };
                
                // Save to API
                fetchAPI('/api/batch-slots', 'POST', data)
                    .then(response => {
                        showNotification(response.message, 'success');
                        this.showQuickAddModal = false;
                        if (this.showDetailsModal) {
                            this.loadBatchSlots(this.selectedBatch.id);
                        }
                        this.loadBatches();  // Refresh batches to update quantities
                    })
                    .catch(error => {
                        console.error('Error saving batch to slot:', error);
                        showNotification('حدث خطأ أثناء حفظ الدفعة في الموقع', 'error');
                    });
            },
            
            removeBatchFromSlot(slot) {
                if (confirm('هل أنت متأكد من رغبتك في إزالة الدفعة من هذا الموقع؟')) {
                    fetchAPI(`/api/batch-slots/${slot.id}`, 'DELETE')
                        .then(response => {
                            showNotification('تم إزالة الدفعة من الموقع بنجاح', 'success');
                            this.loadBatchSlots(this.selectedBatch.id);
                            this.loadBatches();  // Refresh batches to update quantities
                        })
                        .catch(error => {
                            console.error('Error removing batch from slot:', error);
                            showNotification('حدث خطأ أثناء إزالة الدفعة من الموقع', 'error');
                        });
                }
            },
            
            printBatchLabel(batch) {
                this.selectedBatch = batch;
                this.showPrintModal = true;
            },
            
            printLabel() {
                const printContent = document.getElementById('batch-label').innerHTML;
                const originalContent = document.body.innerHTML;
                
                document.body.innerHTML = `
                    <div style="padding: 20px; font-family: Arial, sans-serif;">
                        ${printContent}
                    </div>
                `;
                
                window.print();
                document.body.innerHTML = originalContent;
                
                // Re-initialize Alpine.js after printing
                Alpine.initTree(document.body);
            },
            
            filterBatches() {
                if (!this.batches.length) return;
                
                let filtered = [...this.batches];
                
                // Apply search query
                if (this.searchQuery) {
                    const query = this.searchQuery.toLowerCase();
                    filtered = filtered.filter(batch => 
                        (batch.lot_number && batch.lot_number.toLowerCase().includes(query)) ||
                        (batch.item_name && batch.item_name.toLowerCase().includes(query))
                    );
                }
                
                // Apply item filter
                if (this.filters.itemId) {
                    filtered = filtered.filter(batch => batch.item_id == this.filters.itemId);
                }
                
                // Apply date range filter
                if (this.filters.startDate) {
                    const startDate = new Date(this.filters.startDate);
                    filtered = filtered.filter(batch => {
                        if (!batch.production_date) return true;
                        const batchDate = new Date(batch.production_date);
                        return batchDate >= startDate;
                    });
                }
                
                if (this.filters.endDate) {
                    const endDate = new Date(this.filters.endDate);
                    endDate.setHours(23, 59, 59); // End of day
                    filtered = filtered.filter(batch => {
                        if (!batch.production_date) return true;
                        const batchDate = new Date(batch.production_date);
                        return batchDate <= endDate;
                    });
                }
                
                // Apply status filter
                if (this.filters.status === 'active') {
                    filtered = filtered.filter(batch => !this.isExpired(batch));
                } else if (this.filters.status === 'expired') {
                    filtered = filtered.filter(batch => this.isExpired(batch));
                }
                
                this.filteredBatches = filtered;
            },
            
            resetFilters() {
                this.filters = {
                    itemId: '',
                    startDate: '',
                    endDate: '',
                    status: ''
                };
                this.searchQuery = '';
                this.filterBatches();
            },
            
            isExpired(batch) {
                if (!batch.expiry_date) return false;
                
                const today = new Date();
                const expiryDate = new Date(batch.expiry_date);
                
                return today > expiryDate;
            },
            
            formatDate(dateString) {
                if (!dateString) return '-';
                const date = new Date(dateString);
                return date.toLocaleDateString('ar-EG');
            },
            
            formatDateTime(dateTimeString) {
                if (!dateTimeString) return '-';
                const date = new Date(dateTimeString);
                return date.toLocaleString('ar-EG');
            }
        };
    }
</script>
{% endblock %}

