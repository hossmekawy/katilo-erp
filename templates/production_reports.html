{% extends 'base.html' %}

{% block title %}تقارير الإنتاج - نظام كاتيلو{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
{% endblock %}

{% block page_header %}تقارير الإنتاج{% endblock %}

{% block content %}
<!-- Date Range Selector -->
<div class="bg-white rounded-lg shadow p-4 mb-6">
    <div class="flex flex-wrap items-center">
        <div class="w-full md:w-auto mb-4 md:mb-0 md:ml-4">
            <label for="date-range" class="block text-sm font-medium text-gray-700 mb-1">نطاق التاريخ</label>
            <div class="relative">
                <input type="text" id="date-range" class="form-input block w-full" placeholder="اختر نطاق التاريخ">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-calendar-alt text-gray-400"></i>
                </div>
            </div>
        </div>
        
        <div class="w-full md:w-auto mb-4 md:mb-0 md:ml-4">
            <label for="report-type" class="block text-sm font-medium text-gray-700 mb-1">نوع التقرير</label>
            <select id="report-type" class="form-select block w-full">
                <option value="production">تقرير الإنتاج</option>
                <option value="efficiency">تقرير الكفاءة</option>
                <option value="aging">تقرير التعتيق</option>
                <option value="productivity">تقرير إنتاجية العمال</option>
            </select>
        </div>
        
        <div class="w-full md:w-auto md:ml-4">
            <label for="item-filter" class="block text-sm font-medium text-gray-700 mb-1">تصفية حسب المنتج</label>
            <select id="item-filter" class="form-select block w-full">
                <option value="">جميع المنتجات</option>
                <!-- Will be populated dynamically -->
            </select>
        </div>
        
        <div class="w-full md:w-auto mt-4 md:mt-0 md:mr-auto">
            <button id="generate-report" class="btn btn-primary">
                <i class="fas fa-chart-line ml-2"></i>
                إنشاء التقرير
            </button>
            <button id="export-report" class="btn btn-secondary">
                <i class="fas fa-file-export ml-2"></i>
                تصدير
            </button>
        </div>
    </div>
</div>

<!-- Report Container -->
<div class="bg-white rounded-lg shadow p-4 mb-6">
    <h2 id="report-title" class="text-xl font-bold text-gray-800 mb-4">تقرير الإنتاج</h2>
    
    <!-- KPI Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-blue-50 rounded-lg p-4 border border-blue-100">
            <div class="flex items-center">
                <div class="flex-shrink-0 bg-blue-100 rounded-full p-3">
                    <i class="fas fa-cheese text-blue-500"></i>
                </div>
                <div class="mr-4">
                    <p class="text-sm font-medium text-gray-500">إجمالي الإنتاج</p>
                    <h3 class="text-xl font-bold text-gray-800" id="total-production">--</h3>
                </div>
            </div>
        </div>
        
        <div class="bg-green-50 rounded-lg p-4 border border-green-100">
            <div class="flex items-center">
                <div class="flex-shrink-0 bg-green-100 rounded-full p-3">
                    <i class="fas fa-calendar-check text-green-500"></i>
                </div>
                <div class="mr-4">
                    <p class="text-sm font-medium text-gray-500">دورات الإنتاج المكتملة</p>
                    <h3 class="text-xl font-bold text-gray-800" id="completed-runs">--</h3>
                </div>
            </div>
        </div>
        
        <div class="bg-purple-50 rounded-lg p-4 border border-purple-100">
            <div class="flex items-center">
                <div class="flex-shrink-0 bg-purple-100 rounded-full p-3">
                    <i class="fas fa-percentage text-purple-500"></i>
                </div>
                <div class="mr-4">
                    <p class="text-sm font-medium text-gray-500">متوسط الكفاءة</p>
                    <h3 class="text-xl font-bold text-gray-800" id="avg-efficiency">--</h3>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Chart -->
    <div class="mb-6">
        <canvas id="main-report-chart" height="300"></canvas>
    </div>
    
    <!-- Report Data Table -->
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr id="report-table-header">
                    <!-- Will be populated dynamically based on report type -->
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="report-table-body">
                <tr>
                    <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                        اختر نوع التقرير وانقر على "إنشاء التقرير"
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ar.js"></script>
<script>
    let mainChart = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize date picker
        flatpickr("#date-range", {
            mode: "range",
            dateFormat: "Y-m-d",
            locale: "ar",
            defaultDate: [
                new Date(new Date().setDate(new Date().getDate() - 30)),
                new Date()
            ]
        });
        
        // Load items for filter
        loadItems();
        
        // Set up event listeners
        document.getElementById('generate-report').addEventListener('click', generateReport);
        document.getElementById('export-report').addEventListener('click', exportReport);
        document.getElementById('report-type').addEventListener('change', updateReportTitle);
        
        // Initialize with default report type
        updateReportTitle();
    });
    
    function loadItems() {
        fetch('/api/items')
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('item-filter');
                data.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.name;
                    select.appendChild(option);
                });
            })
            .catch(error => console.error('Error loading items:', error));
    }
    
    function updateReportTitle() {
        const reportType = document.getElementById('report-type').value;
        const titleElement = document.getElementById('report-title');
        
        switch (reportType) {
            case 'production':
                titleElement.textContent = 'تقرير الإنتاج';
                break;
            case 'efficiency':
                titleElement.textContent = 'تقرير الكفاءة';
                break;
            case 'aging':
                titleElement.textContent = 'تقرير التعتيق';
                break;
            case 'productivity':
                titleElement.textContent = 'تقرير إنتاجية العمال';
                break;
        }
    }
    
    function generateReport() {
        const reportType = document.getElementById('report-type').value;
        const dateRange = document.getElementById('date-range').value;
        const itemFilter = document.getElementById('item-filter').value;
        
        // Show loading state
        document.getElementById('total-production').textContent = '...';
        document.getElementById('completed-runs').textContent = '...';
        document.getElementById('avg-efficiency').textContent = '...';
        
        // Clear previous chart
        if (mainChart) {
            mainChart.destroy();
        }
        
        // Fetch report data based on type
        let endpoint = '';
        switch (reportType) {
            case 'production':
                endpoint = '/api/reports/production';
                break;
            case 'efficiency':
                endpoint = '/api/reports/efficiency';
                break;
            case 'aging':
                endpoint = '/api/reports/aging';
                break;
            case 'productivity':
                endpoint = '/api/reports/productivity';
                break;
        }
        
        // Build query parameters
        const params = new URLSearchParams();
        if (dateRange) {
            params.append('date_range', dateRange);
        }
        if (itemFilter) {
            params.append('item_id', itemFilter);
        }
        
        fetch(`${endpoint}?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                // Update KPI cards
                document.getElementById('total-production').textContent = 
                    data.summary.total_production ? `${data.summary.total_production} كجم` : 'غير متاح';
                document.getElementById('completed-runs').textContent = 
                    data.summary.completed_runs || '0';
                document.getElementById('avg-efficiency').textContent = 
                    data.summary.avg_efficiency ? `${data.summary.avg_efficiency}%` : 'غير متاح';
                
                // Create chart
                createReportChart(reportType, data.chart);
                
                // Update table
                updateReportTable(reportType, data.table);
            })
            .catch(error => {
                console.error('Error generating report:', error);
                alert('حدث خطأ أثناء إنشاء التقرير. يرجى المحاولة مرة أخرى.');
            });
    }
    
    function createReportChart(reportType, chartData) {
        const ctx = document.getElementById('main-report-chart').getContext('2d');
        
        let chartConfig = {
            type: 'bar',
            data: {
                labels: chartData.labels,
                datasets: [{
                    label: getChartLabel(reportType),
                    data: chartData.data,
                    backgroundColor: 'rgba(59, 130, 246, 0.5)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            font: {
                                family: 'Tajawal, sans-serif'
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += context.parsed.y;
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: getYAxisLabel(reportType),
                            font: {
                                family: 'Tajawal, sans-serif'
                            }
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: getXAxisLabel(reportType),
                            font: {
                                family: 'Tajawal, sans-serif'
                            }
                        }
                    }
                }
            }
        };
        
        // Special chart types for different reports
        if (reportType === 'efficiency' || reportType === 'productivity') {
            chartConfig.type = 'line';
            chartConfig.data.datasets[0].fill = false;
            chartConfig.data.datasets[0].tension = 0.3;
        }
        
        mainChart = new Chart(ctx, chartConfig);
    }
    
    function updateReportTable(reportType, tableData) {
        const tableHeader = document.getElementById('report-table-header');
        const tableBody = document.getElementById('report-table-body');
        
        // Clear previous content
        tableHeader.innerHTML = '';
        tableBody.innerHTML = '';
        
        // Add headers based on report type
        const headers = getTableHeaders(reportType);
        headers.forEach(header => {
            const th = document.createElement('th');
            th.scope = 'col';
            th.className = 'px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider';
            th.textContent = header;
            tableHeader.appendChild(th);
        });
        
        // Add data rows
        if (tableData.length === 0) {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = headers.length;
            td.className = 'px-6 py-4 text-center text-gray-500';
            td.textContent = 'لا توجد بيانات متاحة';
            tr.appendChild(td);
            tableBody.appendChild(tr);
            return;
        }
        
        tableData.forEach(row => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';
            
            // Add cells based on report type
            switch (reportType) {
                case 'production':
                    addProductionTableRow(tr, row);
                    break;
                case 'efficiency':
                    addEfficiencyTableRow(tr, row);
                    break;
                case 'aging':
                    addAgingTableRow(tr, row);
                    break;
                case 'productivity':
                    addProductivityTableRow(tr, row);
                    break;
            }
            
            tableBody.appendChild(tr);
        });
    }
    
    function addProductionTableRow(tr, row) {
        addTableCell(tr, row.date);
        addTableCell(tr, row.run_id);
        addTableCell(tr, row.item_name);
        addTableCell(tr, row.quantity);
        addTableCell(tr, row.status);
        addTableCell(tr, row.responsible_user);
    }
    
    function addEfficiencyTableRow(tr, row) {
        addTableCell(tr, row.date);
        addTableCell(tr, row.run_id);
        addTableCell(tr, row.planned_quantity);
        addTableCell(tr, row.actual_quantity);
        addTableCell(tr, row.efficiency + '%');
        addTableCell(tr, row.notes);
    }
    
    function addAgingTableRow(tr, row) {
        addTableCell(tr, row.date);
        addTableCell(tr, row.batch_id);
        addTableCell(tr, row.item_name);
        addTableCell(tr, row.aging_room);
        addTableCell(tr, row.temperature + '°C');
        addTableCell(tr, row.humidity + '%');
        addTableCell(tr, row.notes);
    }
    
    function addProductivityTableRow(tr, row) {
        addTableCell(tr, row.date);
        addTableCell(tr, row.worker_name);
        addTableCell(tr, row.items_produced);
        addTableCell(tr, row.hours_worked);
        addTableCell(tr, row.efficiency_score);
        addTableCell(tr, row.notes);
    }
    
    function addTableCell(tr, content) {
        const td = document.createElement('td');
        td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-900';
        td.textContent = content;
        tr.appendChild(td);
    }
    
    function getTableHeaders(reportType) {
        switch (reportType) {
            case 'production':
                return ['التاريخ', 'رقم الدورة', 'المنتج', 'الكمية', 'الحالة', 'المسؤول'];
            case 'efficiency':
                return ['التاريخ', 'رقم الدورة', 'الكمية المخططة', 'الكمية الفعلية', 'الكفاءة', 'ملاحظات'];
            case 'aging':
                return ['التاريخ', 'رقم الدفعة', 'المنتج', 'غرفة التعتيق', 'درجة الحرارة', 'الرطوبة', 'ملاحظات'];
            case 'productivity':
                return ['التاريخ', 'اسم العامل', 'الكمية المنتجة', 'ساعات العمل', 'معدل الكفاءة', 'ملاحظات'];
            default:
                return [];
        }
    }
    
    function getChartLabel(reportType) {
        switch (reportType) {
            case 'production':
                return 'كمية الإنتاج (كجم)';
            case 'efficiency':
                return 'معدل الكفاءة (%)';
            case 'aging':
                return 'عدد دفعات التعتيق';
            case 'productivity':
                return 'معدل الإنتاجية';
            default:
                return '';
        }
    }
    
    function getYAxisLabel(reportType) {
        switch (reportType) {
            case 'production':
                return 'الكمية (كجم)';
            case 'efficiency':
                return 'الكفاءة (%)';
            case 'aging':
                return 'عدد الدفعات';
            case 'productivity':
                return 'معدل الإنتاجية';
            default:
                return '';
        }
    }
    
    function getXAxisLabel(reportType) {
        switch (reportType) {
            case 'production':
            case 'efficiency':
            case 'aging':
            case 'productivity':
                return 'التاريخ';
            default:
                return '';
        }
    }
    
    function exportReport() {
        const reportType = document.getElementById('report-type').value;
        const dateRange = document.getElementById('date-range').value;
        const itemFilter = document.getElementById('item-filter').value;
        
        // Build query parameters
        const params = new URLSearchParams();
        params.append('report_type', reportType);
        if (dateRange) {
            params.append('date_range', dateRange);
        }
        if (itemFilter) {
            params.append('item_id', itemFilter);
        }
        
        // Redirect to export endpoint
        window.location.href = `/api/reports/export?${params.toString()}`;
    }
</script>
{% endblock %}

