{% extends "base.html" %}

{% block title %}إدارة المستودعات - نظام كاتيلو{% endblock %}

{% block page_header %}إدارة المستودعات{% endblock %}

{% block breadcrumbs %}
<li class="flex items-center">
    <i class="fas fa-chevron-right mx-2 text-gray-400 text-xs"></i>
    <span class="text-gray-600 font-medium">إدارة المستودعات</span>
</li>
{% endblock %}

{% block content %}
<div x-data="warehouseManager()" x-init="loadWarehouses()">
    <!-- Page Header with Action Button -->
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold text-gray-800">قائمة المستودعات</h2>
        <button @click="openModal('add')" class="btn btn-primary flex items-center">
            <i class="fas fa-plus ml-2"></i> إضافة مستودع جديد
        </button>
    </div>

    <!-- Search and Filter -->
    <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
        <div class="flex flex-col md:flex-row gap-4">
            <div class="flex-1">
                <label for="search" class="block text-sm font-medium text-gray-700 mb-1">بحث</label>
                <div class="relative">
                    <input type="text" id="search" x-model="searchTerm" @input="filterWarehouses()"
                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                        placeholder="ابحث باسم المستودع أو الموقع...">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Warehouses Table -->
    <div class="bg-white rounded-lg shadow-sm overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            الاسم
                        </th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            الموقع
                        </th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            السعة
                        </th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            معلومات الاتصال
                        </th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            الإجراءات
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-if="filteredWarehouses.length === 0">
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">
                                <div class="flex flex-col items-center justify-center py-6">
                                    <i class="fas fa-warehouse text-gray-300 text-5xl mb-4"></i>
                                    <p class="text-gray-500 mb-2">لا توجد مستودعات متاحة</p>
                                    <button @click="openModal('add')" class="text-blue-600 hover:text-blue-800">
                                        <i class="fas fa-plus ml-1"></i> إضافة مستودع جديد
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </template>
                    <template x-for="warehouse in filteredWarehouses" :key="warehouse.id">
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="warehouse.name"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="warehouse.location || 'غير محدد'"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="warehouse.capacity ? warehouse.capacity + ' وحدة' : 'غير محدد'"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="warehouse.contact_info || 'غير محدد'"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <div class="flex space-x-2 space-x-reverse">
                                    <button @click="openModal('edit', warehouse)" class="text-blue-600 hover:text-blue-900" title="تعديل">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button @click="openModal('view', warehouse)" class="text-gray-600 hover:text-gray-900" title="عرض التفاصيل">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button @click="openInventoryModal(warehouse)" class="text-green-600 hover:text-green-900" title="عرض المخزون">
                                        <i class="fas fa-boxes"></i>
                                    </button>
                                    <button @click="confirmDelete(warehouse)" class="text-red-600 hover:text-red-900" title="حذف">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Warehouse Modal -->
    <div x-show="showModal" class="fixed inset-0 z-50 overflow-y-auto" x-cloak>
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div x-show="showModal" @click="closeModal" class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>

            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

            <div x-show="showModal" 
                 class="inline-block align-bottom bg-white rounded-lg text-right overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full"
                 @click.away="closeModal">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:mt-0 sm:text-right sm:w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4" x-text="modalTitle"></h3>
                            
                            <!-- View Mode -->
                            <template x-if="modalMode === 'view'">
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <div class="grid grid-cols-1 gap-4">
                                        <div>
                                            <h4 class="text-sm font-medium text-gray-500">اسم المستودع</h4>
                                            <p class="mt-1 text-sm text-gray-900" x-text="currentWarehouse.name"></p>
                                        </div>
                                        <div>
                                            <h4 class="text-sm font-medium text-gray-500">الموقع</h4>
                                            <p class="mt-1 text-sm text-gray-900" x-text="currentWarehouse.location || 'غير محدد'"></p>
                                        </div>
                                        <div>
                                            <h4 class="text-sm font-medium text-gray-500">السعة</h4>
                                            <p class="mt-1 text-sm text-gray-900" x-text="currentWarehouse.capacity ? currentWarehouse.capacity + ' وحدة' : 'غير محدد'"></p>
                                        </div>
                                        <div>
                                            <h4 class="text-sm font-medium text-gray-500">معلومات الاتصال</h4>
                                            <p class="mt-1 text-sm text-gray-900" x-text="currentWarehouse.contact_info || 'غير محدد'"></p>
                                        </div>
                                    </div>
                                </div>
                            </template>

                            <!-- Add/Edit Form -->
                            <template x-if="modalMode === 'add' || modalMode === 'edit'">
                                <form @submit.prevent="saveWarehouse">
                                    <div class="grid grid-cols-1 gap-4">
                                        <div>
                                            <label for="name" class="block text-sm font-medium text-gray-700">اسم المستودع <span class="text-red-500">*</span></label>
                                            <input type="text" id="name" x-model="currentWarehouse.name" required
                                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                        </div>
                                        <div>
                                            <label for="location" class="block text-sm font-medium text-gray-700">الموقع</label>
                                            <input type="text" id="location" x-model="currentWarehouse.location"
                                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                        </div>
                                        <div>
                                            <label for="capacity" class="block text-sm font-medium text-gray-700">السعة</label>
                                            <input type="number" id="capacity" x-model="currentWarehouse.capacity" min="0"
                                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                        </div>
                                        <div>
                                            <label for="contact_info" class="block text-sm font-medium text-gray-700">معلومات الاتصال</label>
                                            <textarea id="contact_info" x-model="currentWarehouse.contact_info" rows="3"
                                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></textarea>
                                        </div>
                                    </div>
                                    <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                                        <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                                            <span x-text="modalMode === 'add' ? 'إضافة' : 'تحديث'"></span>
                                        </button>
                                        <button type="button" @click="closeModal" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:w-auto sm:text-sm">
                                            إلغاء
                                        </button>
                                    </div>
                                </form>
                            </template>

                            <!-- Delete Confirmation -->
                            <template x-if="modalMode === 'delete'">
                                <div>
                                    <div class="bg-red-50 p-4 rounded-md mb-4">
                                        <div class="flex">
                                            <div class="flex-shrink-0">
                                                <i class="fas fa-exclamation-triangle text-red-400"></i>
                                            </div>
                                            <div class="mr-3">
                                                <h3 class="text-sm font-medium text-red-800">تأكيد الحذف</h3>
                                                <div class="mt-2 text-sm text-red-700">
                                                    <p>هل أنت متأكد من رغبتك في حذف المستودع <span class="font-bold" x-text="currentWarehouse.name"></span>؟</p>
                                                    <p class="mt-1">هذا الإجراء لا يمكن التراجع عنه.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                                        <button type="button" @click="deleteWarehouse" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
                                            حذف
                                        </button>
                                        <button type="button" @click="closeModal" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:w-auto sm:text-sm">
                                            إلغاء
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Inventory Modal -->
    <div x-show="showInventoryModal" class="fixed inset-0 z-50 overflow-y-auto" x-cloak>
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div x-show="showInventoryModal" @click="closeInventoryModal" class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>

            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

            <div x-show="showInventoryModal" 
                 class="inline-block align-bottom bg-white rounded-lg text-right overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full"
                 @click.away="closeInventoryModal">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">
                            المخزون في مستودع: <span class="font-bold text-blue-600" x-text="currentWarehouse.name"></span>
                        </h3>
                        <button @click="closeInventoryModal" class="text-gray-400 hover:text-gray-500">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <!-- Search for inventory items -->
                    <div class="mb-4">
                        <div class="relative">
                            <input type="text" x-model="inventorySearchTerm" @input="filterInventoryItems()"
                                class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                                placeholder="ابحث عن عنصر...">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Inventory Items Table -->
                    <div class="overflow-x-auto max-h-96">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        رمز العنصر
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        اسم العنصر
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        الفئة
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        الكمية
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        وحدة القياس
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        آخر تحديث
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template x-if="loading">
                                    <tr>
                                        <td colspan="6" class="px-6 py-4 text-center">
                                            <div class="flex justify-center items-center">
                                                <i class="fas fa-spinner fa-spin text-blue-500 mr-2"></i>
                                                جاري تحميل البيانات...
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                                <template x-if="!loading && filteredInventoryItems.length === 0">
                                    <tr>
                                        <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">
                                            <div class="flex flex-col items-center justify-center py-6">
                                                <i class="fas fa-box-open text-gray-300 text-5xl mb-4"></i>
                                                <p class="text-gray-500 mb-2">لا توجد عناصر في هذا المستودع</p>
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                                <template x-for="item in filteredInventoryItems" :key="item.id">
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="item.sku"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="item.name"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="item.category_name"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            <span x-text="item.quantity"></span>
                                            <span x-show="item.quantity <= item.reorder_level" class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                                <i class="fas fa-exclamation-triangle mr-1"></i> منخفض
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="item.unit_of_measure"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="formatDate(item.last_updated)"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" @click="closeInventoryModal" class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        إغلاق
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function warehouseManager() {
        return {
            warehouses: [],
            filteredWarehouses: [],
            currentWarehouse: {
                name: '',
                location: '',
                capacity: null,
                contact_info: ''
            },
            searchTerm: '',
            showModal: false,
            modalMode: 'add', // 'add', 'edit', 'view', 'delete'
            
            // Inventory related properties
            showInventoryModal: false,
            inventoryItems: [],
            filteredInventoryItems: [],
            inventorySearchTerm: '',
            loading: false,
            
            get modalTitle() {
                switch(this.modalMode) {
                    case 'add': return 'إضافة مستودع جديد';
                    case 'edit': return 'تعديل المستودع';
                    case 'view': return 'تفاصيل المستودع';
                    case 'delete': return 'حذف المستودع';
                    default: return '';
                }
            },
            
            async loadWarehouses() {
                try {
                    const response = await fetchAPI('/api/warehouses');
                    this.warehouses = response;
                    this.filterWarehouses();
                } catch (error) {
                    console.error('Error loading warehouses:', error);
                    showNotification('حدث خطأ أثناء تحميل بيانات المستودعات', 'error');
                }
            },
            
            filterWarehouses() {
                if (!this.searchTerm.trim()) {
                    this.filteredWarehouses = [...this.warehouses];
                    return;
                }
                
                const searchLower = this.searchTerm.toLowerCase();
                this.filteredWarehouses = this.warehouses.filter(warehouse => 
                    warehouse.name.toLowerCase().includes(searchLower) || 
                    (warehouse.location && warehouse.location.toLowerCase().includes(searchLower))
                );
            },
            
            openModal(mode, warehouse = null) {
                this.modalMode = mode;
                
                if (warehouse) {
                    this.currentWarehouse = { ...warehouse };
                } else {
                    this.currentWarehouse = {
                        name: '',
                        location: '',
                        capacity: null,
                        contact_info: ''
                    };
                }
                
                this.showModal = true;
            },
            
            closeModal() {
                this.showModal = false;
            },
            
            confirmDelete(warehouse) {
                this.currentWarehouse = { ...warehouse };
                this.openModal('delete');
            },
            
            async saveWarehouse() {
                try {
                    // Validate form
                    if (!this.currentWarehouse.name) {
                        showNotification('اسم المستودع مطلوب', 'error');
                        return;
                    }
                    
                    let response;
                    
                    if (this.modalMode === 'add') {
                        response = await fetchAPI('/api/warehouses', 'POST', this.currentWarehouse);
                        showNotification('تم إضافة المستودع بنجاح', 'success');
                    } else {
                        response = await fetchAPI(`/api/warehouses/${this.currentWarehouse.id}`, 'PUT', this.currentWarehouse);
                        showNotification('تم تحديث المستودع بنجاح', 'success');
                    }
                    
                    // Refresh the warehouses list
                    await this.loadWarehouses();
                    this.closeModal();
                } catch (error) {
                    console.error('Error saving warehouse:', error);
                    showNotification('حدث خطأ أثناء حفظ بيانات المستودع', 'error');
                }
            },
            
            async deleteWarehouse() {
                try {
                    await fetchAPI(`/api/warehouses/${this.currentWarehouse.id}`, 'DELETE');
                    
                    // Remove from local array
                    this.warehouses = this.warehouses.filter(w => w.id !== this.currentWarehouse.id);
                    this.filterWarehouses();
                    
                    showNotification('تم حذف المستودع بنجاح', 'success');
                    this.closeModal();
                } catch (error) {
                    console.error('Error deleting warehouse:', error);
                    showNotification(error.message || 'حدث خطأ أثناء حذف المستودع', 'error');
                }
            },
            
            // Inventory related methods
            async openInventoryModal(warehouse) {
                this.currentWarehouse = { ...warehouse };
                this.showInventoryModal = true;
                this.inventoryItems = [];
                this.filteredInventoryItems = [];
                this.inventorySearchTerm = '';
                this.loading = true;
                
                try {
                    const response = await fetchAPI(`/api/warehouses/${warehouse.id}/inventory`);
                    this.inventoryItems = response;
                    this.filteredInventoryItems = [...this.inventoryItems];
                    this.loading = false;
                } catch (error) {
                    console.error('Error loading inventory:', error);
                    showNotification('حدث خطأ أثناء تحميل بيانات المخزون', 'error');
                    this.loading = false;
                }
            },
            
            closeInventoryModal() {
                this.showInventoryModal = false;
            },
            
            filterInventoryItems() {
                if (!this.inventorySearchTerm.trim()) {
                    this.filteredInventoryItems = [...this.inventoryItems];
                    return;
                }
                
                const searchLower = this.inventorySearchTerm.toLowerCase();
                this.filteredInventoryItems = this.inventoryItems.filter(item => 
                    item.name.toLowerCase().includes(searchLower) || 
                    item.sku.toLowerCase().includes(searchLower) ||
                    (item.category_name && item.category_name.toLowerCase().includes(searchLower))
                );
            },
            
            formatDate(dateString) {
                if (!dateString) return 'غير محدد';
                
                const date = new Date(dateString);
                return new Intl.DateTimeFormat('ar-EG', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }).format(date);
            }
        };
    }
</script>
{% endblock %}

