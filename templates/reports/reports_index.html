{% extends "base.html" %}

{% block title %}التقارير - نظام كاتيلو{% endblock %}

{% block page_header %}التقارير{% endblock %}

{% block breadcrumbs %}
<li class="flex items-center">
    <i class="fas fa-chevron-right mx-2 text-gray-400 text-xs"></i>
    <span class="text-gray-600 font-medium">التقارير</span>
</li>
{% endblock %}

{% block content %}
<div class="space-y-6" x-data="reportsPage()">
    <!-- Reports Dashboard -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Report Requests Card -->
        <div class="card p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">طلبات التقارير</h3>
                <span class="text-blue-600 bg-blue-100 rounded-full px-3 py-1 text-sm font-medium" x-text="stats.pendingRequests + ' طلب'"></span>
            </div>
            <div class="space-y-4">
                <div class="flex items-center justify-between text-sm">
                    <span class="text-gray-600">قيد الانتظار</span>
                    <span class="font-medium" x-text="stats.pendingRequests"></span>
                </div>
                <div class="flex items-center justify-between text-sm">
                    <span class="text-gray-600">تم إنشاؤها</span>
                    <span class="font-medium" x-text="stats.completedRequests"></span>
                </div>
                <div class="flex items-center justify-between text-sm">
                    <span class="text-gray-600">مرفوضة</span>
                    <span class="font-medium" x-text="stats.rejectedRequests"></span>
                </div>
            </div>
            <div class="mt-6">
                <a href="/reports/my-requests" class="btn bg-blue-50 text-blue-700 hover:bg-blue-100 w-full">
                    <i class="fas fa-list ml-2"></i> عرض طلباتي
                </a>
            </div>
        </div>
        
        <!-- Report Templates Card -->
        <div class="card p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">قوالب التقارير</h3>
                <span class="text-green-600 bg-green-100 rounded-full px-3 py-1 text-sm font-medium" x-text="stats.templates + ' قالب'"></span>
            </div>
            <div class="space-y-4">
                <template x-for="(count, type) in stats.templatesByType" :key="type">
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-gray-600" x-text="getReportTypeName(type)"></span>
                        <span class="font-medium" x-text="count"></span>
                    </div>
                </template>
            </div>
            <div class="mt-6">
                <a href="/reports/templates" class="btn bg-green-50 text-green-700 hover:bg-green-100 w-full">
                    <i class="fas fa-file-alt ml-2"></i> إدارة القوالب
                </a>
            </div>
        </div>
        
        <!-- Recent Reports Card -->
        <div class="card p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">التقارير الأخيرة</h3>
                <span class="text-purple-600 bg-purple-100 rounded-full px-3 py-1 text-sm font-medium" x-text="stats.recentReports + ' تقرير'"></span>
            </div>
            <div class="space-y-3">
                <template x-for="report in recentReports" :key="report.id">
                    <div class="flex items-center justify-between text-sm border-b border-gray-100 pb-2">
                        <div>
                            <div class="font-medium text-gray-900" x-text="report.name"></div>
                            <div class="text-xs text-gray-500" x-text="formatDate(report.created_at)"></div>
                        </div>
                        <a :href="'/reports/view/' + report.id" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-eye"></i>
                        </a>
                    </div>
                </template>
                <div x-show="recentReports.length === 0" class="text-center text-gray-500 py-2">
                    لا توجد تقارير حديثة
                </div>
            </div>
            <div class="mt-6">
                <a href="/reports/history" class="btn bg-purple-50 text-purple-700 hover:bg-purple-100 w-full">
                    <i class="fas fa-history ml-2"></i> سجل التقارير
                </a>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="card p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">إجراءات سريعة</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <a href="/reports/request" class="flex flex-col items-center p-4 border border-gray-200 rounded-lg hover:bg-blue-50 hover:border-blue-200 transition-colors">
                <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center mb-3">
                    <i class="fas fa-plus text-blue-600"></i>
                </div>
                <div class="text-center">
                    <div class="font-medium text-gray-900">طلب تقرير جديد</div>
                    <div class="text-xs text-gray-500 mt-1">إنشاء طلب لتقرير مخصص</div>
                </div>
            </a>
            
            <a href="/reports/templates" class="flex flex-col items-center p-4 border border-gray-200 rounded-lg hover:bg-green-50 hover:border-green-200 transition-colors">
                <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center mb-3">
                    <i class="fas fa-file-alt text-green-600"></i>
                </div>
                <div class="text-center">
                    <div class="font-medium text-gray-900">قوالب التقارير</div>
                    <div class="text-xs text-gray-500 mt-1">إدارة قوالب التقارير</div>
                </div>
            </a>
            
            <a href="/reports/scheduled" class="flex flex-col items-center p-4 border border-gray-200 rounded-lg hover:bg-yellow-50 hover:border-yellow-200 transition-colors">
                <div class="w-12 h-12 rounded-full bg-yellow-100 flex items-center justify-center mb-3">
                    <i class="fas fa-calendar-alt text-yellow-600"></i>
                </div>
                <div class="text-center">
                    <div class="font-medium text-gray-900">التقارير المجدولة</div>
                    <div class="text-xs text-gray-500 mt-1">إدارة التقارير الدورية</div>
                </div>
            </a>
            
            <a href="/reports/history" class="flex flex-col items-center p-4 border border-gray-200 rounded-lg hover:bg-purple-50 hover:border-purple-200 transition-colors">
                <div class="w-12 h-12 rounded-full bg-purple-100 flex items-center justify-center mb-3">
                    <i class="fas fa-history text-purple-600"></i>
                </div>
                <div class="text-center">
                    <div class="font-medium text-gray-900">سجل التقارير</div>
                    <div class="text-xs text-gray-500 mt-1">عرض التقارير السابقة</div>
                </div>
            </a>
        </div>
    </div>
    
    <!-- Popular Reports -->
    <div class="card p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">التقارير الشائعة</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="border border-gray-200 rounded-lg overflow-hidden">
                <div class="bg-blue-50 p-4">
                    <h4 class="font-medium text-blue-800">تقرير المخزون الحالي</h4>
                </div>
                <div class="p-4">
                    <p class="text-sm text-gray-600 mb-4">عرض حالة المخزون الحالية لجميع العناصر في المستودعات.</p>
                    <a href="/reports/generate/inventory" class="btn bg-blue-600 text-white hover:bg-blue-700 w-full">
                        <i class="fas fa-download ml-2"></i> إنشاء التقرير
                    </a>
                </div>
            </div>
            
            <div class="border border-gray-200 rounded-lg overflow-hidden">
                <div class="bg-green-50 p-4">
                    <h4 class="font-medium text-green-800">تقرير العناصر منخفضة المخزون</h4>
                </div>
                <div class="p-4">
                    <p class="text-sm text-gray-600 mb-4">عرض العناصر التي وصلت إلى مستوى إعادة الطلب أو أقل.</p>
                    <a href="/reports/generate/low-stock" class="btn bg-green-600 text-white hover:bg-green-700 w-full">
                        <i class="fas fa-download ml-2"></i> إنشاء التقرير
                    </a>
                </div>
            </div>
            
            <div class="border border-gray-200 rounded-lg overflow-hidden">
                <div class="bg-purple-50 p-4">
                    <h4 class="font-medium text-purple-800">تقرير معاملات المخزون</h4>
                </div>
                <div class="p-4">
                    <p class="text-sm text-gray-600 mb-4">عرض سجل معاملات المخزون (إدخال/إخراج) خلال الشهر الحالي.</p>
                    <a href="/reports/generate/transactions" class="btn bg-purple-600 text-white hover:bg-purple-700 w-full">
                        <i class="fas fa-download ml-2"></i> إنشاء التقرير
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function reportsPage() {
        return {
            stats: {
                pendingRequests: 0,
                completedRequests: 0,
                rejectedRequests: 0,
                templates: 0,
                templatesByType: {},
                recentReports: 0
            },
            recentReports: [],
            
            async init() {
                await this.loadStats();
                await this.loadRecentReports();
            },
            
            async loadStats() {
                try {
                    const response = await fetch('/api/reports/stats');
                    const data = await response.json();
                    
                    if (data.success) {
                        this.stats = data.stats;
                    }
                } catch (error) {
                    console.error('Error loading report stats:', error);
                }
            },
            
            async loadRecentReports() {
                try {
                    const response = await fetch('/api/reports/recent');
                    const data = await response.json();
                    
                    if (data.success) {
                        this.recentReports = data.reports;
                    }
                } catch (error) {
                    console.error('Error loading recent reports:', error);
                }
            },
            
            formatDate(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                return new Intl.DateTimeFormat('ar-EG', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }).format(date);
            },
            
            getReportTypeName(type) {
                const reportTypes = {
                    'Inventory': 'المخزون',
                    'Transactions': 'المعاملات',
                    'Suppliers': 'الموردين',
                    'SupplierAccounts': 'حسابات الموردين',
                    'Production': 'الإنتاج',
                    'QualityControl': 'مراقبة الجودة',
                    'Warehouses': 'المستودعات',
                    'Items': 'العناصر',
                    'Categories': 'التصنيفات',
                    'PurchaseOrders': 'طلبات الشراء',
                    'BOM': 'قوائم المواد'
                };
                
                return reportTypes[type] || type;
            }
        };
    }
</script>
{% endblock %}
