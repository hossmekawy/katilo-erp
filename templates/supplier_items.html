{% extends "base.html" %}

{% block title %}إدارة عناصر المورد - نظام كاتيلو{% endblock %}

{% block page_header %}إدارة عناصر المورد{% endblock %}

{% block content %}
<div x-data="supplierItemsApp">
    <!-- Header with actions -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">عناصر المورد: <span x-text="supplierName" class="text-blue-600"></span></h1>
            <p class="text-gray-600 mt-1" x-show="supplier.contact_info">
                <i class="fas fa-phone-alt mr-1"></i> <span x-text="supplier.contact_info"></span>
            </p>
        </div>
        <div class="flex space-x-2 space-x-reverse">
            <a href="/suppliers" class="btn bg-gray-200 hover:bg-gray-300 text-gray-700 flex items-center">
                <i class="fas fa-arrow-right mr-2"></i> العودة للموردين
            </a>
            <button @click="openAddModal()" class="btn btn-primary flex items-center">
                <i class="fas fa-plus mr-2"></i> إضافة عنصر
            </button>
        </div>
    </div>

    <!-- Supplier Rating -->
    <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="font-medium text-gray-700">تقييم المورد</h3>
                <div class="flex items-center mt-1">
                    <template x-for="i in 5" :key="i">
                        <i class="fas fa-star text-lg cursor-pointer" 
                           :class="i <= supplier.rating ? 'text-yellow-400' : 'text-gray-300'"
                           @click="updateRating(i)"></i>
                    </template>
                    <span class="mr-2 text-gray-600" x-text="supplier.rating || 0"></span>
                </div>
            </div>
            <div class="text-sm text-gray-500">
                <div x-show="supplier.payment_terms">
                    <span class="font-medium">شروط الدفع:</span> <span x-text="supplier.payment_terms"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and filters -->
    <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
        <div class="flex flex-col md:flex-row gap-4">
            <div class="flex-1">
                <label for="search" class="block text-sm font-medium text-gray-700 mb-1">بحث</label>
                <div class="relative">
                    <input type="text" id="search" x-model="searchQuery" 
                           class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                           placeholder="ابحث باسم العنصر...">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                </div>
            </div>
            <div class="w-full md:w-48">
                <label for="sort" class="block text-sm font-medium text-gray-700 mb-1">ترتيب حسب</label>
                <select id="sort" x-model="sortBy"
                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    <option value="name">الاسم</option>
                    <option value="cost">التكلفة</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Supplier Items list -->
    <div class="bg-white rounded-lg shadow-sm overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            اسم العنصر
                        </th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            الرمز التعريفي
                        </th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            رمز المورد
                        </th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            التكلفة
                        </th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            المخزون الحالي
                        </th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            الإجراءات
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-for="item in filteredItems" :key="item.id">
                        <tr class="hover:bg-gray-50" :class="{'bg-red-50': isLowStock(item)}">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900" x-text="item.item_name"></div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-500" x-text="item.sku || '-'"></div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-500" x-text="item.supplier_sku || '-'"></div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900" x-text="formatCurrency(item.cost)"></div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm" :class="isLowStock(item) ? 'text-red-600 font-semibold' : 'text-gray-900'" x-text="item.current_stock || 0"></div>
                                <div class="text-xs text-gray-500" x-show="isLowStock(item)">
                                    <span class="text-red-500">أقل من المستوى المطلوب</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-left text-sm font-medium">
                                <div class="flex space-x-2 space-x-reverse">
                                    <button @click="editItem(item)" class="text-indigo-600 hover:text-indigo-900">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button @click="confirmDelete(item)" class="text-red-600 hover:text-red-900">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    <button @click="createPurchaseOrder(item)" class="text-green-600 hover:text-green-900" x-show="isLowStock(item)">
                                        <i class="fas fa-shopping-cart"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </template>
                    <tr x-show="filteredItems.length === 0">
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                            لا توجد عناصر متطابقة مع البحث
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add/Edit Item Modal -->
    <div x-show="showModal" class="fixed inset-0 overflow-y-auto z-50" x-cloak>
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-right overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:mt-0 sm:text-right sm:w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" x-text="isEditing ? 'تعديل العنصر' : 'إضافة عنصر جديد'"></h3>
                            <div class="mt-4 space-y-4">
                                <div x-show="!isEditing">
                                    <label for="item_id" class="block text-sm font-medium text-gray-700">العنصر</label>
                                    <div class="flex space-x-2 space-x-reverse">
                                        <select id="item_id" x-model="currentItem.item_id" 
                                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                            <option value="">اختر العنصر</option>
                                            <template x-for="item in availableItems" :key="item.id">
                                                <option :value="item.id" x-text="item.name + ' (' + item.sku + ')'"></option>
                                            </template>
                                        </select>
                                        <a href="/items-management" 
                                           class="mt-1 inline-flex items-center px-3 py-2 border border-blue-300 shadow-sm text-sm leading-4 font-medium rounded-md text-blue-700 bg-white hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                            <i class="fas fa-plus-circle ml-1"></i>
                                            إضافة عنصر
                                        </a>
                                    </div>
                                </div>
                                <div>                                    
                                    <label for="supplier_sku" class="block text-sm font-medium text-gray-700">رمز المورد (اختياري)</label>
                                    <input type="text" id="supplier_sku" x-model="currentItem.supplier_sku" 
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="cost" class="block text-sm font-medium text-gray-700">التكلفة</label>
                                    <input type="number" id="cost" x-model="currentItem.cost" step="0.01" min="0"
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button @click="saveItem()" type="button" 
                            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                        حفظ
                    </button>
                    <button @click="closeModal()" type="button" 
                            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        إلغاء
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div x-show="showDeleteModal" class="fixed inset-0 overflow-y-auto z-50" x-cloak>
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-right overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                            <i class="fas fa-exclamation-triangle text-red-600"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:mr-4 sm:text-right">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">حذف العنصر</h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500">
                                    هل أنت متأكد من رغبتك في حذف هذا العنصر من قائمة المورد؟ لا يمكن التراجع عن هذا الإجراء.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button @click="deleteItem()" type="button" 
                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
                    حذف
                </button>
                <button @click="showDeleteModal = false" type="button" 
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    إلغاء
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Purchase Order Modal -->
<div x-show="showPurchaseModal" class="fixed inset-0 overflow-y-auto z-50" x-cloak>
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-right overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:text-right sm:w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">إنشاء طلب شراء</h3>
                        <div class="mt-4 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">العنصر</label>
                                <div class="mt-1 text-sm text-gray-900" x-text="purchaseItem.item_name"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">المورد</label>
                                <div class="mt-1 text-sm text-gray-900" x-text="supplierName"></div>
                            </div>
                            <div>
                                <label for="po_quantity" class="block text-sm font-medium text-gray-700">الكمية المطلوبة</label>
                                <input type="number" id="po_quantity" x-model="purchaseOrder.quantity" min="1"
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="po_unit_price" class="block text-sm font-medium text-gray-700">سعر الوحدة</label>
                                <input type="number" id="po_unit_price" x-model="purchaseOrder.unit_price" step="0.01" min="0"
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="po_notes" class="block text-sm font-medium text-gray-700">ملاحظات</label>
                                <textarea id="po_notes" x-model="purchaseOrder.notes" rows="3"
                                          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></textarea>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-gray-700">الإجمالي:</span>
                                    <span class="text-lg font-bold text-gray-900" x-text="formatCurrency(purchaseOrder.quantity * purchaseOrder.unit_price)"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button @click="submitPurchaseOrder()" type="button" 
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:ml-3 sm:w-auto sm:text-sm">
                    إنشاء الطلب
                </button>
                <button @click="showPurchaseModal = false" type="button" 
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    إلغاء
                </button>
            </div>
        </div>
    </div>
</div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('supplierItemsApp', () => ({
        supplier: {},
        supplierItems: [],
        allItems: [],
        availableItems: [],
        searchQuery: '',
        sortBy: 'name',
        showModal: false,
        showDeleteModal: false,
        showPurchaseModal: false,
        isEditing: false,
        currentItem: {
            id: null,
            supplier_id: null,
            item_id: '',
            supplier_sku: '',
            cost: 0
        },
        purchaseItem: {},
        purchaseOrder: {
            quantity: 1,
            unit_price: 0,
            notes: ''
        },
        
        async init() {
            // Get supplier ID from URL query parameter
            const urlParams = new URLSearchParams(window.location.search);
            const supplierId = urlParams.get('supplier_id');
            
            if (!supplierId) {
                showNotification('معرف المورد غير موجود', 'error');
                window.location.href = '/suppliers';
                return;
            }
            
            try {
                // Fetch supplier details
                this.supplier = await fetchAPI(`/api/suppliers/${supplierId}`);
                
                // Fetch supplier items
                const supplierItemsResponse = await fetchAPI(`/api/suppliers/${supplierId}/items`);
                this.supplierItems = supplierItemsResponse;
                
                // Fetch all items for adding new supplier items
                const allItemsResponse = await fetchAPI('/api/items');
                this.allItems = allItemsResponse;
                
                // Update available items (items not already associated with this supplier)
                this.updateAvailableItems();
                
                // Fetch current inventory levels for each item
                await this.fetchInventoryLevels();
            } catch (error) {
                console.error('Error initializing supplier items page:', error);
                showNotification('حدث خطأ أثناء تحميل البيانات', 'error');
            }
        },
        
        get supplierName() {
            return this.supplier.supplier_name || '';
        },
        
        get filteredItems() {
            let filtered = [...this.supplierItems];
            
            // Apply search filter
            if (this.searchQuery) {
                const query = this.searchQuery.toLowerCase();
                filtered = filtered.filter(item => 
                    item.item_name.toLowerCase().includes(query) ||
                    (item.sku && item.sku.toLowerCase().includes(query)) ||
                    (item.supplier_sku && item.supplier_sku.toLowerCase().includes(query))
                );
            }
            
            // Apply sorting
            filtered.sort((a, b) => {
                if (this.sortBy === 'cost') {
                    return a.cost - b.cost;
                } else {
                    return a.item_name.localeCompare(b.item_name);
                }
            });
            
            return filtered;
        },
        
        updateAvailableItems() {
            // Filter out items that are already associated with this supplier
            const supplierItemIds = this.supplierItems.map(item => item.item_id);
            this.availableItems = this.allItems.filter(item => !supplierItemIds.includes(item.id));
        },
        
        async fetchInventoryLevels() {
            try {
                // Fetch inventory data
                const inventoryResponse = await fetchAPI('/api/inventory');
                
                // Update supplier items with current stock levels
                this.supplierItems = this.supplierItems.map(item => {
                    // Calculate total quantity across all warehouses
                    const itemInventory = inventoryResponse.filter(inv => inv.item_id === item.item_id);
                    const totalQuantity = itemInventory.reduce((sum, inv) => sum + inv.quantity, 0);
                    
                    return {
                        ...item,
                        current_stock: totalQuantity
                    };
                });
            } catch (error) {
                console.error('Error fetching inventory levels:', error);
            }
        },
        
        isLowStock(item) {
            // Find the item in allItems to get its reorder_level
            const itemDetails = this.allItems.find(i => i.id === item.item_id);
            if (!itemDetails) return false;
            
            return (item.current_stock || 0) <= itemDetails.reorder_level;
        },
        
        formatCurrency(value) {
            return parseFloat(value).toFixed(2) + ' ج.م';
        },
        
        openAddModal() {
            this.isEditing = false;
            this.currentItem = {
                id: null,
                supplier_id: this.supplier.id,
                item_id: '',
                supplier_sku: '',
                cost: 0
            };
            this.showModal = true;
        },
        
        editItem(item) {
            this.isEditing = true;
            this.currentItem = { ...item };
            this.showModal = true;
        },
        
        closeModal() {
            this.showModal = false;
        },
        
        async saveItem() {
            try {
                // Validate required fields
                if (!this.isEditing && !this.currentItem.item_id) {
                    showNotification('يرجى اختيار العنصر', 'error');
                    return;
                }
                
                if (this.currentItem.cost <= 0) {
                    showNotification('يجب أن تكون التكلفة أكبر من صفر', 'error');
                    return;
                }
                
                let response;
                if (this.isEditing) {
                    // Update existing supplier item
                    response = await fetchAPI(`/api/supplier-items/${this.currentItem.id}`, 'PUT', this.currentItem);
                } else {
                    // Create new supplier item
                    response = await fetchAPI('/api/supplier-items', 'POST', this.currentItem);
                }
                
                // Refresh supplier items
                const supplierItemsResponse = await fetchAPI(`/api/suppliers/${this.supplier.id}/items`);
                this.supplierItems = supplierItemsResponse;
                
                // Update available items
                this.updateAvailableItems();
                
                // Fetch current inventory levels
                await this.fetchInventoryLevels();
                
                this.closeModal();
                showNotification(this.isEditing ? 'تم تحديث العنصر بنجاح' : 'تم إضافة العنصر بنجاح', 'success');
            } catch (error) {
                console.error('Error saving supplier item:', error);
                showNotification('حدث خطأ أثناء حفظ العنصر', 'error');
            }
        },
        
        confirmDelete(item) {
            this.currentItem = item;
            this.showDeleteModal = true;
        },
        
        async deleteItem() {
            try {
                await fetchAPI(`/api/supplier-items/${this.currentItem.id}`, 'DELETE');
                
                // Refresh supplier items
                const supplierItemsResponse = await fetchAPI(`/api/suppliers/${this.supplier.id}/items`);
                this.supplierItems = supplierItemsResponse;
                
                // Update available items
                this.updateAvailableItems();
                
                this.showDeleteModal = false;
                showNotification('تم حذف العنصر بنجاح', 'success');
            } catch (error) {
                console.error('Error deleting supplier item:', error);
                showNotification('حدث خطأ أثناء حذف العنصر', 'error');
            }
        },
        
        createPurchaseOrder(item) {
            this.purchaseItem = item;
            this.purchaseOrder = {
                quantity: Math.max(1, item.reorder_quantity || 1),
                unit_price: item.cost,
                notes: ''
            };
            this.showPurchaseModal = true;
        },
        
        async submitPurchaseOrder() {
            try {
                // Validate required fields
                if (this.purchaseOrder.quantity <= 0) {
                    showNotification('يجب أن تكون الكمية أكبر من صفر', 'error');
                    return;
                }
                
                if (this.purchaseOrder.unit_price <= 0) {
                    showNotification('يجب أن يكون سعر الوحدة أكبر من صفر', 'error');
                    return;
                }
                                    // Create purchase order
                                    const purchaseOrderData = {
                                        supplier_id: this.supplier.id,
                                        items: [{
                                            item_id: this.purchaseItem.item_id,
                                            quantity_ordered: this.purchaseOrder.quantity,
                                            unit_price: this.purchaseOrder.unit_price
                                        }],
                                        notes: this.purchaseOrder.notes
                                    };
                                    
                                    const response = await fetchAPI('/api/purchase-orders', 'POST', purchaseOrderData);
                                    
                                    this.showPurchaseModal = false;
                                    showNotification('تم إنشاء طلب الشراء بنجاح', 'success');
                                    
                                    // Optionally redirect to the purchase order details page
                                    if (response && response.id) {
                                        window.location.href = `/purchase-orders/${response.id}`;
                                    }
                                } catch (error) {
                                    console.error('Error creating purchase order:', error);
                                    showNotification('حدث خطأ أثناء إنشاء طلب الشراء', 'error');
                                }
                            },
                            
                            async updateRating(rating) {
                                try {
                                    // Update supplier rating
                                    const updatedSupplier = {
                                        ...this.supplier,
                                        rating: rating
                                    };
                                    
                                    await fetchAPI(`/api/suppliers/${this.supplier.id}`, 'PUT', updatedSupplier);
                                    
                                    // Update local supplier object
                                    this.supplier.rating = rating;
                                    
                                    showNotification('تم تحديث تقييم المورد بنجاح', 'success');
                                } catch (error) {
                                    console.error('Error updating supplier rating:', error);
                                    showNotification('حدث خطأ أثناء تحديث تقييم المورد', 'error');
                                }
                            }
                        }));
                    });
                </script>
                {% endblock %}
                
